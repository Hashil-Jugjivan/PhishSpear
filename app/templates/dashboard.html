{% extends 'base.html' %}
{% block title %}Dashboard - PhishSpear{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-4">ðŸ“Š Campaign Dashboard</h2>

  {% if campaigns %}
    <!-- Summary Statistics -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <h5 class="card-title">Total Campaigns</h5>
            <h3 class="mb-0">{{ campaigns|length }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body">
            <h5 class="card-title">Total Clicks</h5>
            <h3 class="mb-0">{{ campaigns|sum(attribute='clicks') }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-dark">
          <div class="card-body">
            <h5 class="card-title">Total Submissions</h5>
            <h3 class="mb-0">{{ campaigns|sum(attribute='submissions') }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body">
            <h5 class="card-title">Click Rate</h5>
            <h3 class="mb-0">
              {% if campaigns|length > 0 %}
                {{ "%.1f"|format((campaigns|sum(attribute='clicks') / campaigns|length)) }}%
              {% else %}
                0%
              {% endif %}
            </h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">ðŸ“ˆ Campaign Performance Overview</h5>
          </div>
          <div class="card-body">
            <canvas id="campaignChart" style="max-height: 400px;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Table -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">ðŸ“‹ Campaign Details</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="table-dark">
              <tr>
                <th>Recipient</th>
                <th>Template</th>
                <th>UID</th>
                <th>Clicks</th>
                <th>Submissions</th>
                <th>Status</th>
                <th>Submitted Email</th>
                <th>Submitted Password</th>
              </tr>
            </thead>
            <tbody>
              {% for c in campaigns %}
              <tr>
                <td>{{ c.recipient }}</td>
                <td>
                  <span class="badge bg-secondary">{{ c.template }}</span>
                </td>
                <td>
                  <code>{{ c.uid }}</code>
                </td>
                <td>
                  {% if c.clicks > 0 %}
                    <span class="badge bg-info">{{ c.clicks }}</span>
                  {% else %}
                    <span class="badge bg-light text-dark">0</span>
                  {% endif %}
                </td>
                <td>
                  {% if c.submissions > 0 %}
                    <span class="badge bg-warning">{{ c.submissions }}</span>
                  {% else %}
                    <span class="badge bg-light text-dark">0</span>
                  {% endif %}
                </td>
                <td>
                  {% if c.submissions > 0 %}
                    <span class="badge bg-danger">Compromised</span>
                  {% elif c.clicks > 0 %}
                    <span class="badge bg-warning">Clicked</span>
                  {% else %}
                    <span class="badge bg-success">Safe</span>
                  {% endif %}
                </td>
                <td>
                  {% if c.submitted_email %}
                    <code>{{ c.submitted_email }}</code>
                    {% if c.submitted_email == c.recipient %}
                      <span class="badge bg-danger ms-1">Match</span>
                    {% else %}
                      <span class="badge bg-warning ms-1">Different</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
                <td>
                  {% if c.submitted_password %}
                    <span class="text-danger">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="togglePassword('pwd-{{ loop.index }}')">
                      <i class="bi bi-eye"></i>
                    </button>
                    <span id="pwd-{{ loop.index }}" style="display: none;" class="ms-2">
                      <code>{{ c.submitted_password }}</code>
                    </span>
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      <h5>ðŸ‘‹ Welcome to PhishSpear!</h5>
      <p class="mb-0">You haven't launched any campaigns yet. Head to the <a href="/" class="alert-link">home page</a> to create your first phishing simulation.</p>
    </div>
  {% endif %}
</div>

<!-- Chart.js Integration -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Password toggle functionality
  function togglePassword(elementId) {
    const element = document.getElementById(elementId);
    const button = element.previousElementSibling;
    const icon = button.querySelector('i');
    
    if (element.style.display === 'none') {
      element.style.display = 'inline';
      icon.className = 'bi bi-eye-slash';
    } else {
      element.style.display = 'none';
      icon.className = 'bi bi-eye';
    }
  }
</script>
{% if campaigns %}
<script>
  // Chart data preparation
  const campaignData = { campaigns , tojson , safe };
  
  // Extract data for chart
  const labels = campaignData.map(c => c.recipient.length > 15 ? 
    c.recipient.substring(0, 15) + '...' : c.recipient);
  const clicksData = campaignData.map(c => c.clicks);
  const submissionsData = campaignData.map(c => c.submissions);

  // Create the chart
  const ctx = document.getElementById('campaignChart').getContext('2d');
  const campaignChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Clicks',
          data: clicksData,
          backgroundColor: 'rgba(13, 110, 253, 0.6)',
          borderColor: 'rgba(13, 110, 253, 1)',
          borderWidth: 2,
          borderRadius: 4,
          borderSkipped: false,
        },
        {
          label: 'Submissions',
          data: submissionsData,
          backgroundColor: 'rgba(220, 53, 69, 0.6)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 2,
          borderRadius: 4,
          borderSkipped: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Campaign Performance: Clicks vs Submissions',
          font: {
            size: 16,
            weight: 'bold'
          }
        },
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            callback: function(value) {
              return Number.isInteger(value) ? value : '';
            }
          },
          title: {
            display: true,
            text: 'Number of Interactions'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Campaign Recipients'
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      },
      animation: {
        duration: 1500,
        easing: 'easeInOutQuart'
      }
    }
  });
</script>
{% endif %}
{% endblock %}

